name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: ðŸ›¡ï¸ Quality Guard
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Dependencies
        run: bun install

      - name: ðŸ§¹ Lint (ESLint)
        run: bun run lint

      - name: ðŸ’… Format Check (Prettier)
        run: bun x prettier --check "{nest,utils,env,features,cli}/**/*.ts"

      - name: ðŸ‘® Type Check (TSC)
        run: bun run typecheck

      - name: ðŸ§ª Run Tests & Coverage
        run: |
          # è¿è¡Œæµ‹è¯•å¹¶å°†è¾“å‡ºæ•èŽ·åˆ°æ–‡ä»¶ï¼ŒåŒæ—¶ä¿ç•™é€€å‡ºç 
          # ä½¿ç”¨ pipefail ç¡®ä¿å¦‚æžœæµ‹è¯•å¤±è´¥ï¼Œæ•´ä¸ªç®¡é“è¿”å›žå¤±è´¥
          set -o pipefail

          # è¿è¡Œæµ‹è¯•ï¼Œæ•èŽ·è¾“å‡º
          bun test --coverage 2>&1 | tee test-output.log

          TEST_EXIT_CODE=$?

          # --- ç”Ÿæˆ GitHub Summary ---
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $TEST_EXIT_CODE -eq 0 ]; then
             echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
             echo "âŒ **Tests Failed!** Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          # å°è¯•æå–è¦†ç›–çŽ‡è¡¨æ ¼ï¼ˆä»Ž 'File' å¼€å§‹åˆ°ç»“æŸï¼‰
          if grep -q "File" test-output.log; then
            sed -n '/File/,$p' test-output.log >> $GITHUB_STEP_SUMMARY
          else
            tail -n 30 test-output.log >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

          # å¦‚æžœæµ‹è¯•å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯ä¸­æ­¢ Action
          exit $TEST_EXIT_CODE
